# ==============================================================================
# Muti Metroo - Example Configuration
# ==============================================================================

# ------------------------------------------------------------------------------
# Agent Identity
# ------------------------------------------------------------------------------
agent:
  # Agent ID: "auto" generates on first run, or specify hex string
  id: "auto"

  # Human-readable display name (Unicode allowed, e.g., "Tallinn Gateway")
  # If not set, falls back to agent ID for display
  display_name: ""

  # Directory for persistent state (agent_id, etc.)
  data_dir: "./data"

  # Logging configuration
  log_level: "info"   # debug, info, warn, error
  log_format: "text"  # text, json

# ------------------------------------------------------------------------------
# Transport Listeners
# Listen for incoming peer connections
# ------------------------------------------------------------------------------
listeners:
  # QUIC listener (best performance, recommended)
  - transport: quic
    address: "0.0.0.0:4433"
    tls:
      # Option 1: File paths
      cert: "./certs/agent.crt"
      key: "./certs/agent.key"
      # Optional: require client certificates (mTLS)
      # client_ca: "./certs/ca.crt"

      # Option 2: Inline PEM (takes precedence over file paths)
      # Useful for single-file configs or Kubernetes secrets
      # cert_pem: |
      #   -----BEGIN CERTIFICATE-----
      #   MIIBkTCB+wIJAK...
      #   -----END CERTIFICATE-----
      # key_pem: |
      #   -----BEGIN PRIVATE KEY-----
      #   MIIEvQIBADANBg...
      #   -----END PRIVATE KEY-----
      # ca_pem: |
      #   -----BEGIN CERTIFICATE-----
      #   ...
      #   -----END CERTIFICATE-----

  # HTTP/2 listener (TCP fallback)
  # - transport: h2
  #   address: "0.0.0.0:8443"
  #   path: "/mesh"
  #   tls:
  #     cert: "./certs/agent.crt"
  #     key: "./certs/agent.key"

  # WebSocket listener (maximum proxy compatibility)
  # - transport: ws
  #   address: "0.0.0.0:443"
  #   path: "/mesh"
  #   tls:
  #     cert: "./certs/agent.crt"
  #     key: "./certs/agent.key"

# ------------------------------------------------------------------------------
# Peer Connections
# Connect to other agents in the mesh
# ------------------------------------------------------------------------------
peers:
  # Example QUIC peer
  # - id: "abc123def456789012345678901234ab"  # Expected peer AgentID
  #   transport: quic
  #   address: "192.168.1.50:4433"
  #   tls:
  #     ca: "./certs/peer-ca.crt"
  #     # Or use certificate pinning:
  #     # fingerprint: "sha256:ab12cd34..."

  # Example WebSocket peer through corporate proxy
  # - id: "ghi789jkl012345678901234567890cd"
  #   transport: ws
  #   address: "wss://relay.example.com:443/mesh"
  #   proxy: "http://proxy.corp.local:8080"
  #   proxy_auth:
  #     username: "${PROXY_USER}"
  #     password: "${PROXY_PASS}"

# ------------------------------------------------------------------------------
# SOCKS5 Server
# Accept client connections (ingress role)
# ------------------------------------------------------------------------------
socks5:
  enabled: true
  address: "127.0.0.1:1080"

  # Optional authentication
  auth:
    enabled: false
    users:
      # Option 1: Plaintext password (deprecated, for development only)
      # - username: "user1"
      #   password: "pass1"

      # Option 2: bcrypt password hash (recommended for production)
      # Generate with: htpasswd -bnBC 10 "" <password> | tr -d ':\n'
      # Or use: muti-metroo hash-password <password>
      - username: "user1"
        password_hash: "$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy"

  # Connection limits
  max_connections: 1000

# ------------------------------------------------------------------------------
# Exit Configuration
# Open real TCP connections to destinations (exit role)
# ------------------------------------------------------------------------------
exit:
  enabled: false

  # CIDR routes to advertise to mesh
  routes:
    # - "10.0.0.0/8"
    # - "192.168.0.0/16"
    # - "0.0.0.0/0"  # Default route (be careful!)

  # DNS settings for domain resolution
  dns:
    servers:
      - "8.8.8.8:53"
      - "1.1.1.1:53"
    timeout: 5s

# ------------------------------------------------------------------------------
# Routing
# Route advertisement and propagation settings
# ------------------------------------------------------------------------------
routing:
  advertise_interval: 2m  # How often to re-advertise routes
  route_ttl: 5m           # How long routes are valid
  max_hops: 16            # Maximum path length (TTL)

# ------------------------------------------------------------------------------
# Connection Tuning
# Peer connection behavior
# ------------------------------------------------------------------------------
connections:
  # Keepalive settings
  idle_threshold: 30s  # Send keepalive after this idle time
  timeout: 90s         # Declare peer dead after no response

  # Reconnection behavior
  reconnect:
    initial_delay: 1s
    max_delay: 60s
    multiplier: 2.0
    jitter: 0.2
    max_retries: 0     # 0 = infinite

# ------------------------------------------------------------------------------
# Resource Limits
# Prevent resource exhaustion
# ------------------------------------------------------------------------------
limits:
  max_streams_per_peer: 1000
  max_streams_total: 10000
  max_pending_opens: 100
  stream_open_timeout: 30s
  buffer_size: 262144  # 256 KB per stream

# ------------------------------------------------------------------------------
# HTTP API Server
# Health checks, Prometheus metrics, remote agent APIs
# ------------------------------------------------------------------------------
http:
  enabled: true
  address: ":8080"
  read_timeout: 10s
  write_timeout: 10s

# ------------------------------------------------------------------------------
# Control Socket
# Unix socket for CLI commands (status, peers, routes)
# ------------------------------------------------------------------------------
control:
  enabled: true
  socket_path: "./data/control.sock"

# ------------------------------------------------------------------------------
# Remote Procedure Call (RPC)
# Execute shell commands on remote agents
# ------------------------------------------------------------------------------
rpc:
  enabled: false               # Disabled by default for security
  whitelist: []                # Empty = no commands allowed; ["*"] = all (testing only!)
  # whitelist:                 # Commands must be base names only (no paths)
  #   - whoami
  #   - hostname
  #   - ip
  password_hash: ""            # bcrypt hash of RPC password
                               # Generate: htpasswd -bnBC 10 "" <password> | tr -d ':\n'
                               # Or use: muti-metroo hash-password <password>
  timeout: 60s                 # Default command execution timeout
