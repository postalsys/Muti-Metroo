# ==============================================================================
# Muti Metroo - Example Configuration
# ==============================================================================

# ------------------------------------------------------------------------------
# Agent Identity
# ------------------------------------------------------------------------------
agent:
  # Agent ID: "auto" generates on first run, or specify hex string
  id: "auto"

  # Human-readable display name (Unicode allowed, e.g., "Tallinn Gateway")
  # If not set, falls back to agent ID for display
  display_name: ""

  # Directory for persistent state (agent_id, etc.)
  data_dir: "./data"

  # Logging configuration
  log_level: "info"   # debug, info, warn, error
  log_format: "text"  # text, json

# ------------------------------------------------------------------------------
# Global TLS Configuration
# Single CA and agent certificate used for all connections
# ------------------------------------------------------------------------------
tls:
  # CA certificate for verifying peers and client certificates (mTLS)
  ca: "./certs/ca.crt"
  # Or inline PEM (takes precedence over file path):
  # ca_pem: |
  #   -----BEGIN CERTIFICATE-----
  #   ...
  #   -----END CERTIFICATE-----

  # Agent's identity certificate (used by listeners and peer connections)
  cert: "./certs/agent.crt"
  key: "./certs/agent.key"
  # Or inline PEM:
  # cert_pem: |
  #   -----BEGIN CERTIFICATE-----
  #   ...
  #   -----END CERTIFICATE-----
  # key_pem: |
  #   -----BEGIN PRIVATE KEY-----
  #   ...
  #   -----END PRIVATE KEY-----

  # Enable mutual TLS on listeners (require client certificates)
  mtls: true

# ------------------------------------------------------------------------------
# Protocol Identifiers (OPSEC Customization)
# These identifiers appear in network traffic and can be customized for evasion
# ------------------------------------------------------------------------------
protocol:
  # ALPN (Application-Layer Protocol Negotiation) for QUIC and TLS connections
  # Default: "muti-metroo/1". Set to empty string "" to disable custom ALPN.
  alpn: "muti-metroo/1"

  # Custom HTTP header for HTTP/2 transport protocol identification
  # Default: "X-Muti-Metroo-Protocol". Set to empty string "" to disable.
  http_header: "X-Muti-Metroo-Protocol"

  # WebSocket subprotocol identifier
  # Default: "muti-metroo/1". Set to empty string "" to disable.
  ws_subprotocol: "muti-metroo/1"

# Example: Stealth configuration (disable all custom protocol identifiers)
# protocol:
#   alpn: ""
#   http_header: ""
#   ws_subprotocol: ""

# ------------------------------------------------------------------------------
# Transport Listeners
# Listen for incoming peer connections
# ------------------------------------------------------------------------------
listeners:
  # QUIC listener (best performance, recommended)
  - transport: quic
    address: "0.0.0.0:4433"
    # Optional per-listener overrides (uses global tls settings if not specified):
    # tls:
    #   cert: "./certs/listener-specific.crt"
    #   key: "./certs/listener-specific.key"
    #   mtls: false  # Override global mTLS setting

  # HTTP/2 listener (TCP fallback)
  # - transport: h2
  #   address: "0.0.0.0:8443"
  #   path: "/mesh"

  # WebSocket listener (maximum proxy compatibility)
  # - transport: ws
  #   address: "0.0.0.0:443"
  #   path: "/mesh"

  # WebSocket behind reverse proxy (plaintext mode)
  # - transport: ws
  #   address: "0.0.0.0:8080"
  #   path: "/mesh"
  #   plaintext: true  # No TLS - proxy handles it

# ------------------------------------------------------------------------------
# Peer Connections
# Connect to other agents in the mesh
# ------------------------------------------------------------------------------
peers:
  # Example QUIC peer (uses global CA and cert for mTLS)
  # - id: "abc123def456789012345678901234ab"
  #   transport: quic
  #   address: "192.168.1.50:4433"
  #   # Optional per-peer overrides:
  #   # tls:
  #   #   ca: "./certs/other-ca.crt"  # Override global CA
  #   #   fingerprint: "sha256:ab12cd34..."  # Certificate pinning

  # Example WebSocket peer through corporate proxy
  # Note: mTLS not available through proxy (external server may use RSA)
  # - id: "ghi789jkl012345678901234567890cd"
  #   transport: ws
  #   address: "wss://relay.example.com:443/mesh"
  #   proxy: "http://proxy.corp.local:8080"
  #   proxy_auth:
  #     username: "${PROXY_USER}"
  #     password: "${PROXY_PASS}"

# ------------------------------------------------------------------------------
# SOCKS5 Server
# Accept client connections (ingress role)
# ------------------------------------------------------------------------------
socks5:
  enabled: true
  address: "127.0.0.1:1080"

  # Optional authentication
  auth:
    enabled: false
    users:
      # Option 1: Plaintext password (deprecated, for development only)
      # - username: "user1"
      #   password: "pass1"

      # Option 2: bcrypt password hash (recommended for production)
      # Generate with: htpasswd -bnBC 10 "" <password> | tr -d ':\n'
      # Or use: muti-metroo hash <password>
      - username: "user1"
        password_hash: "$2a$10$N9qo8uLOickgx2ZMRZoMyeIjZAgcfl7p92ldGxad68LJZdL17lhWy"

  # Connection limits
  max_connections: 1000

# ------------------------------------------------------------------------------
# Exit Configuration
# Open real TCP connections to destinations (exit role)
# ------------------------------------------------------------------------------
exit:
  enabled: false

  # CIDR routes to advertise to mesh
  routes:
    # - "10.0.0.0/8"
    # - "192.168.0.0/16"
    # - "0.0.0.0/0"  # Default route (be careful!)

  # DNS settings for domain resolution
  dns:
    servers:
      - "8.8.8.8:53"
      - "1.1.1.1:53"
    timeout: 5s

# ------------------------------------------------------------------------------
# Routing
# Route advertisement and propagation settings
# ------------------------------------------------------------------------------
routing:
  advertise_interval: 2m  # How often to re-advertise routes
  route_ttl: 5m           # How long routes are valid
  max_hops: 16            # Maximum path length (TTL)

# ------------------------------------------------------------------------------
# Connection Tuning
# Peer connection behavior
# ------------------------------------------------------------------------------
connections:
  # Keepalive settings
  idle_threshold: 30s    # Send keepalive after this idle time
  timeout: 90s           # Declare peer dead after no response
  keepalive_jitter: 0.2  # Timing jitter (0.0-1.0) to avoid detectable beacon patterns
                         # 0.2 = 20% jitter, so 30s becomes 24-36s range

  # Reconnection behavior
  reconnect:
    initial_delay: 1s
    max_delay: 60s
    multiplier: 2.0
    jitter: 0.2
    max_retries: 0     # 0 = infinite

# ------------------------------------------------------------------------------
# Resource Limits
# Prevent resource exhaustion
# ------------------------------------------------------------------------------
limits:
  max_streams_per_peer: 1000
  max_streams_total: 10000
  max_pending_opens: 100
  stream_open_timeout: 30s
  buffer_size: 262144  # 256 KB per stream

# ------------------------------------------------------------------------------
# HTTP API Server
# Health checks, dashboard, remote agent APIs
# ------------------------------------------------------------------------------
http:
  enabled: true
  address: ":8080"
  read_timeout: 10s
  write_timeout: 10s

  # Minimal mode: only enable /health, /healthz, /ready endpoints
  # When true, overrides all endpoint flags below to false
  minimal: false

  # Endpoint group controls (all default to true when http.enabled=true)
  # Set to false to disable (returns 404 with debug logging)
  pprof: false       # /debug/pprof/* - Go profiling (disable in production)
  dashboard: true    # /ui/*, /api/* - Web dashboard and visualization
  remote_api: true   # /agents/* - Distributed mesh APIs

# Example: Minimal OPSEC configuration (health endpoints only)
# http:
#   enabled: true
#   address: "127.0.0.1:8080"
#   minimal: true

# ------------------------------------------------------------------------------
# Remote Shell
# Execute shell commands on remote agents (interactive and streaming modes)
# ------------------------------------------------------------------------------
shell:
  enabled: false               # Disabled by default for security
  whitelist: []                # Empty = no commands allowed; ["*"] = all (testing only!)
  # whitelist:                 # Commands must be base names only (no paths)
  #   - whoami
  #   - hostname
  #   - bash
  #   - vim
  password_hash: ""            # bcrypt hash of shell password
                               # Generate with: muti-metroo hash
  timeout: 0s                  # Optional command timeout (0 = no timeout)
  max_sessions: 0              # Max concurrent sessions (0 = unlimited)

# ------------------------------------------------------------------------------
# File Transfer
# Upload/download files to/from remote agents
# ------------------------------------------------------------------------------
file_transfer:
  enabled: false               # Disabled by default for security
  max_file_size: 524288000     # 500 MB (0 = unlimited)
  allowed_paths: []            # Empty = no paths allowed; ["*"] = all paths
  # allowed_paths:             # Path prefixes and glob patterns
  #   - /tmp                   # Prefix: allows /tmp and everything under it
  #   - /data/**               # Recursive glob: any path under /data
  #   - /home/*/uploads        # Wildcard: uploads dir for any user
  #   - /var/log/*.log         # Extension: only .log files in /var/log
  password_hash: ""            # bcrypt hash of file transfer password
                               # Generate with: muti-metroo hash <password>

# ------------------------------------------------------------------------------
# UDP Relay Configuration
# Enable UDP relay for SOCKS5 UDP ASSOCIATE (RFC 1928)
# ------------------------------------------------------------------------------
udp:
  enabled: false               # Disabled by default
  max_associations: 1000       # Max concurrent UDP associations
  idle_timeout: 5m             # Association timeout after inactivity
  max_datagram_size: 1472      # Max UDP payload (MTU - IP/UDP headers)

# ------------------------------------------------------------------------------
# Management Key Encryption
# Encrypt mesh topology data for OPSEC protection
# ------------------------------------------------------------------------------
management:
  # Management public key (64-character hex string)
  # When set, NodeInfo and route paths are encrypted before flooding
  # All agents in mesh should have the SAME public key
  # Generate with: muti-metroo management-key generate
  public_key: ""

  # Management private key (64-character hex string)
  # Only set on operator/management nodes that need to view topology
  # NEVER distribute to field agents
  # When set, this node can decrypt NodeInfo and view mesh topology
  private_key: ""

# Example: Field agent (encrypt only, cannot view topology)
# management:
#   public_key: "a1b2c3d4e5f6789012345678901234567890123456789012345678901234abcd"

# Example: Operator node (can decrypt and view topology)
# management:
#   public_key: "a1b2c3d4e5f6789012345678901234567890123456789012345678901234abcd"
#   private_key: "e5f6a7b8c9d012345678901234567890123456789012345678901234567890ef"
