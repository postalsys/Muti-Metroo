# Test stage - runs all tests with coverage
FROM golang:1.23-alpine

WORKDIR /app

# Install test dependencies
RUN apk add --no-cache git make gcc musl-dev netcat-openbsd openssh-client

# Copy go mod files first for caching
COPY go.mod ./

# Download and tidy dependencies
RUN go mod download || true

# Copy source code
COPY . .

# Tidy dependencies to generate go.sum
RUN go mod tidy

# Run tests with race detector and coverage
CMD ["go", "test", "-v", "-race", "-coverprofile=/app/coverage.out", "./..."]
