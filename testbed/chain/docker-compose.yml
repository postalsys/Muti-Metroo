# Chain topology: A → B → C → D
# Agent A: SOCKS5 ingress, connects to B
# Agent B: Transit, listens for A, connects to C
# Agent C: Transit, listens for B, connects to D
# Agent D: Exit node with CIDR routes
#
# Usage:
#   docker compose up -d
#   docker compose logs -f
#   docker compose down

version: '3.8'

services:
  agent-a:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: chain-agent-a
    hostname: agentA
    volumes:
      - ./agentA/data:/app/data
      - ./agentA/config.yaml:/app/config.yaml:ro
      - ./certs:/app/certs:ro
    ports:
      - "11081:1080"    # SOCKS5 proxy
      - "18081:8080"    # Health/Metrics
    networks:
      - chain
    depends_on:
      - agent-b

  agent-b:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: chain-agent-b
    hostname: agentB
    volumes:
      - ./agentB/data:/app/data
      - ./agentB/config.yaml:/app/config.yaml:ro
      - ./certs:/app/certs:ro
    ports:
      - "18082:8080"    # Health/Metrics
    networks:
      - chain
    depends_on:
      - agent-c

  agent-c:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: chain-agent-c
    hostname: agentC
    volumes:
      - ./agentC/data:/app/data
      - ./agentC/config.yaml:/app/config.yaml:ro
      - ./certs:/app/certs:ro
    ports:
      - "18083:8080"    # Health/Metrics
    networks:
      - chain
    depends_on:
      - agent-d

  agent-d:
    build:
      context: ../..
      dockerfile: Dockerfile
    container_name: chain-agent-d
    hostname: agentD
    volumes:
      - ./agentD/data:/app/data
      - ./agentD/config.yaml:/app/config.yaml:ro
      - ./certs:/app/certs:ro
    ports:
      - "18084:8080"    # Health/Metrics
    networks:
      - chain

  # Target server for testing exit routes
  target:
    image: nginx:alpine
    container_name: chain-target
    hostname: target
    networks:
      chain:
        ipv4_address: 172.29.0.100

networks:
  chain:
    driver: bridge
    ipam:
      config:
        - subnet: 172.29.0.0/16
