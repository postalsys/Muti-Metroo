# Setup Wizard

The interactive setup wizard is the easiest way to configure Muti Metroo. It guides you through all configuration steps with sensible defaults.

## Running the Wizard

```bash
muti-metroo setup
```

## Wizard Steps

The wizard walks you through 13 steps, though some are conditional based on your role selections.

### Step 1: Basic Setup

- **Config file path**: Where to save the configuration (default: `./config.yaml`)
- **Data directory**: Where agent state is stored (default: `./data`)
- **Display name**: Human-readable name shown in the dashboard API (optional)

### Step 2: Agent Role

Choose one or more roles for your agent:

| Role | Description |
|------|-------------|
| **Ingress** | SOCKS5 proxy for client connections |
| **Transit** | Relay traffic between peers |
| **Exit** | Open connections to external destinations |

You can select multiple roles to create a combined agent.

### Step 3: Network Configuration

- **Transport type**: QUIC (recommended), HTTP/2, or WebSocket
- **Listen address**: IP and port to listen on (e.g., `0.0.0.0:4433`)
- **HTTP path**: Path for HTTP-based transports (default: `/mesh`)

### Step 4: TLS Configuration (Optional)

TLS certificates are auto-generated by default. E2E encryption (X25519 + ChaCha20-Poly1305) secures all traffic regardless of TLS settings.

- **Self-signed certificates (default)**: Auto-generate at startup - no configuration needed
- **Strict TLS with CA verification (advanced)**: For PKI-based certificate verification (includes mTLS option)

### Step 5: Peer Connections

Optionally connect to existing mesh agents:

- Enter peer address (host:port)
- Specify expected agent ID (or `auto` for first connection)
- Select transport type
- Configure TLS verification
- Connectivity test with retry/skip options

### Step 6: SOCKS5 Configuration (Ingress Role)

If ingress role is selected:

- **Listen address**: Where to accept SOCKS5 connections
- **Authentication**: Enable/disable, add username and password

### Step 7: Exit Configuration (Exit Role)

If exit role is selected:

- **CIDR routes**: Networks to advertise (e.g., `0.0.0.0/0`, `::/0`). If no routes entered, defaults to all traffic (`0.0.0.0/0` and `::/0`)
- **Domain routes**: Domain patterns for domain-based routing (optional)

### Step 8: Advanced Options

- **Log level**: Debug, Info (default), Warning, or Error
- **HTTP API**: Enable health check endpoint for monitoring and CLI

### Step 9: Remote Shell Access

- **Enable shell**: Allow remote command execution (disabled by default)
- **Password**: Required for shell authentication (min 8 characters)
- **Command whitelist**: No commands, all commands, or custom list

### Step 10: File Transfer

- **Enable file transfer**: Allow file upload/download (disabled by default)
- **Password**: Required for file transfer authentication
- **Max file size**: Limit in MB (default: 500 MB)
- **Path restrictions**: Allow all paths or restrict to specific directories

### Step 11: Management Key Encryption

Network compartmentalization for enhanced privacy:

- **Skip**: No encryption (not recommended for sensitive deployments)
- **Generate new**: Create a new management keypair
- **Enter existing**: Use an existing public key

When enabled, mesh topology data is encrypted so isolated network segments cannot reveal the overall network structure.

### Step 12: Configuration Delivery

Choose how to deploy the configuration:

| Option | Description |
|--------|-------------|
| **Save to file** | Traditional `config.yaml` file (default) |
| **Embed in binary** | Single-file deployment with config baked in |

For both options, you specify a **service name** used when installing as a system service (default: `muti-metroo`).

When embedding:
- **Output path**: Where to save the embedded binary

When you choose to embed config, the wizard **automatically** embeds the identity:
- `agent.id` is set to the generated agent ID
- `agent.private_key` is set to the generated X25519 private key
- `agent.data_dir` is cleared (not needed)

The resulting binary can run without any external files - true single-file deployment.

### Step 13: Service Installation

If running with elevated privileges, optionally install as a system service:

- **Linux**: systemd service (requires root)
- **macOS**: launchd service (requires root)
- **Windows**: Windows Service (requires Administrator)

For Windows without Administrator access, use the CLI after the wizard:

```powershell
muti-metroo service install --user --dll path\to\muti-metroo.dll -c path\to\config.yaml
```

This uses the Registry Run key for automatic startup at user logon.

## Example Wizard Session

```
$ muti-metroo setup

================================================================================
                        Muti Metroo Setup Wizard
================================================================================
                    Userspace Mesh Networking Agent

--------------------------------------------------------------------------------
Basic Setup
--------------------------------------------------------------------------------
Configure the essential paths for your agent.

Config File Path [./config.yaml]:
Data Directory [./data]:
Display Name (press Enter to use Agent ID) []: Gateway Agent

--------------------------------------------------------------------------------
Agent Role
--------------------------------------------------------------------------------
Select the roles this agent will perform.
You can select multiple roles.

  1. [ ] Ingress (SOCKS5 proxy entry point)
  2. [ ] Transit (relay traffic between peers)
  3. [ ] Exit (connect to external networks)

Select Roles (comma-separated) []: 1,3

--------------------------------------------------------------------------------
Network Configuration
--------------------------------------------------------------------------------
Configure how this agent listens for connections.

Transport Protocol (QUIC is recommended for best performance):

> 1. QUIC (UDP, fastest)
  2. HTTP/2 (TCP, firewall-friendly)
  3. WebSocket (TCP, proxy-friendly)

Select [1]:
Listen Address [0.0.0.0:4433]:

--------------------------------------------------------------------------------
TLS Configuration (Optional)
--------------------------------------------------------------------------------
TLS certificates are auto-generated by default.
E2E encryption secures all traffic regardless of TLS settings.

> 1. Self-Signed Certificates (Recommended)
  2. Strict TLS with CA verification (Advanced)

Certificate Setup [1]:

[OK] TLS certificates will be auto-generated at startup

--------------------------------------------------------------------------------
Peer Connections
--------------------------------------------------------------------------------
Configure connections to other mesh agents.

Add peer connections? [y/N]: n

--------------------------------------------------------------------------------
SOCKS5 Proxy
--------------------------------------------------------------------------------
Configure the SOCKS5 ingress proxy.

Listen Address [127.0.0.1:1080]:
Enable authentication? [y/N]: n

--------------------------------------------------------------------------------
Exit Node Configuration
--------------------------------------------------------------------------------
Configure this agent as an exit node.
It will allow traffic to specified networks.

Allowed Routes (CIDR) - one CIDR per line (e.g., 0.0.0.0/0 for all traffic):
Enter routes, one per line. Enter empty line to finish.
Route (or empty to finish) []: 0.0.0.0/0
Route (or empty to finish) []: ::/0
Route (or empty to finish) []:

--------------------------------------------------------------------------------
Domain Routes (Optional)
--------------------------------------------------------------------------------
Route traffic by domain name.
Examples: api.internal.corp, *.example.com

Enter domain patterns, one per line. Enter empty line to finish.
Domain (or empty to finish) []:

--------------------------------------------------------------------------------
Advanced Options
--------------------------------------------------------------------------------
Configure monitoring and logging.

  Debug (verbose)
> Info (recommended)
  Warning
  Error (quiet)

Log Level [2]:
Enable health check endpoint? (HTTP endpoint for monitoring and CLI) [Y/n]: y

--------------------------------------------------------------------------------
Remote Shell Access
--------------------------------------------------------------------------------
Shell allows executing commands remotely on this agent.
Commands must be whitelisted for security.

Enable Remote Shell? (requires authentication) [y/N]: n

--------------------------------------------------------------------------------
File Transfer
--------------------------------------------------------------------------------
File transfer allows uploading and downloading files to/from this agent.
Files are transferred via the control channel.

Enable file transfer? (requires authentication) [y/N]: n

--------------------------------------------------------------------------------
Management Key Encryption (Privacy Protection)
--------------------------------------------------------------------------------
Encrypt mesh topology data so only administrators can view it.
Isolated agents will only see encrypted blobs.

This is recommended for sensitive deployments.

> 1. Skip (not recommended for sensitive deployments)
  2. Generate new management keypair
  3. Enter existing public key

Management Key Setup [1]:

--------------------------------------------------------------------------------
Configuration Delivery
--------------------------------------------------------------------------------
Choose how to deploy the configuration.
Embedding creates a single-file binary with config baked in.

> 1. Save to config file (traditional)
  2. Embed in binary (single-file deployment)

Delivery method [1]:
[INFO] Service name is used when installing as a system service.
Service name [muti-metroo]:

--------------------------------------------------------------------------------
[OK] Setup Complete!
--------------------------------------------------------------------------------

  Display Name:   Gateway Agent
  Agent ID:       abc123def456789012345678901234567
  E2E Public Key: 0123456789abcdef0123456789abcdef...
  Config file:    ./config.yaml
  Data dir:       ./data

  Listener:     quic://0.0.0.0:4433
  SOCKS5:       127.0.0.1:1080
  Exit routes:  [0.0.0.0/0 ::/0]
  HTTP API:     http://:8080

  To start the agent:
    muti-metroo run -c ./config.yaml
```

## After the Wizard

Once the wizard completes:

1. **Configuration saved**: Your `config.yaml` is ready
2. **Agent initialized**: Identity stored in data directory
3. **TLS certificates**: Auto-generated at startup (or saved to `./certs/` if using strict mode)

### Start the Agent Manually

If you did not start during the wizard:

```bash
muti-metroo run -c ./config.yaml
```

### Verify Operation

```bash
# Check health
curl http://localhost:8080/health

# Get detailed status
curl http://localhost:8080/healthz | jq

# Test SOCKS5 (if exit is enabled)
curl -x socks5://localhost:1080 https://example.com
```

## Re-running the Wizard

You can run the wizard again to modify configuration:

```bash
muti-metroo setup

# Existing config detected
Use existing configuration as base? [y]: y
```

The wizard will load existing values as defaults.

## Embedded Configuration

For single-file deployments, the wizard can embed configuration directly into the binary.

### Creating an Embedded Binary

During setup, choose "Embed in binary" when prompted:

```
Configuration Delivery
----------------------
> 1. Save to config file (traditional)
  2. Embed in binary (single-file deployment)

Delivery method [1]: 2
Service name [muti-metroo]: my-agent
Output binary path: ./my-agent
```

### Running Embedded Binary

```bash
# No config file or run command needed
./my-agent

# Output shows embedded config detection
Using embedded configuration
Starting Muti Metroo agent...
Display Name: my-agent
```

### Editing Embedded Configuration

To modify config in an existing embedded binary:

```bash
# Use regular binary to edit embedded one
muti-metroo setup -c /path/to/embedded-binary
```

The wizard extracts existing config as defaults, guides you through changes, and writes updated config back to the binary.

### Updating Deployed Agents

```bash
# Stop service
sudo systemctl stop my-agent

# Edit embedded config
muti-metroo setup -c /usr/local/bin/my-agent

# Restart service
sudo systemctl start my-agent
```

### Binary Format

```
[executable][XOR'd config][8-byte length][8-byte magic]
```

The XOR obfuscation prevents casual inspection but is not cryptographic security.

## Service Installation via Wizard

When running the wizard with elevated privileges, you can install as a system service:

### Linux (as root)

```bash
sudo muti-metroo setup
# At the end, choose to install as service
```

### Windows (as Administrator)

```powershell
# Run as Administrator
.\muti-metroo.exe setup
```

The wizard will offer to:

1. Create configuration in the appropriate system location
2. Register the system service
3. Enable automatic startup
4. Start the service
