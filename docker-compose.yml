version: '3.8'

services:
  # Test runner service
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    volumes:
      - ./coverage:/app/coverage
    command: >
      sh -c "go test -v -race -coverprofile=/app/coverage/coverage.out ./... &&
             go tool cover -func=/app/coverage/coverage.out"

  # Build verification
  build:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["--version"]

  # 3-agent mesh testbed
  agent1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: muti-metroo-agent1
    hostname: agent1
    volumes:
      - ./testbed/agent1/data:/app/data
      - ./testbed/agent1/config.yaml:/app/config.yaml:ro
      - ./testbed/certs:/app/certs:ro
    ports:
      - "31080:1080"   # SOCKS5 (mapped to 31080 to avoid conflicts)
      - "8081:8080"   # Health/Metrics
    networks:
      - mesh
    depends_on:
      - agent2

  agent2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: muti-metroo-agent2
    hostname: agent2
    volumes:
      - ./testbed/agent2/data:/app/data
      - ./testbed/agent2/config.yaml:/app/config.yaml:ro
      - ./testbed/certs:/app/certs:ro
    ports:
      - "8082:8080"   # Health/Metrics
    networks:
      - mesh
    depends_on:
      - agent3

  agent3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: muti-metroo-agent3
    hostname: agent3
    volumes:
      - ./testbed/agent3/data:/app/data
      - ./testbed/agent3/config.yaml:/app/config.yaml:ro
      - ./testbed/certs:/app/certs:ro
    ports:
      - "8083:8080"   # Health/Metrics
    networks:
      - mesh

  # Target server for testing
  target:
    image: nginx:alpine
    container_name: muti-metroo-target
    hostname: target
    networks:
      mesh:
        ipv4_address: 172.28.0.100

networks:
  mesh:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
