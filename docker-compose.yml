version: '3.8'

services:
  # Test runner service
  test:
    build:
      context: .
      dockerfile: Dockerfile.test
    volumes:
      - ./coverage:/app/coverage
    command: >
      sh -c "go test -v -race -coverprofile=/app/coverage/coverage.out ./... &&
             go tool cover -func=/app/coverage/coverage.out"

  # Build verification
  build:
    build:
      context: .
      dockerfile: Dockerfile
    command: ["--version"]

  # 6-agent mesh testbed with mixed transports
  # Topology: A->B, B<-C, C->D, C<-E, E->F, D<-F
  #
  #     A (agent1)
  #     |
  #     v  QUIC
  #     B (agent2) <--- C (agent3) ---> D (agent4)
  #                H2        ^      WS       ^
  #                          |               |
  #                    QUIC  |               | WS
  #                          |               |
  #                    E (agent5) ---> F (agent6)
  #                               H2

  # Agent A: SOCKS5 ingress, connects to B via QUIC
  agent1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: muti-metroo-agent1
    hostname: agent1
    volumes:
      - ./testbed/agent1/data:/app/data
      - ./testbed/agent1/config.yaml:/app/config.yaml:ro
      - ./testbed/certs:/app/certs:ro
    extra_hosts:
      - "host.docker.internal:host-gateway"
    ports:
      - "1090:1080"   # SOCKS5
      - "8191:8080"   # Health/Metrics
    networks:
      - mesh
    depends_on:
      - agent2

  # Agent B: Transit hub, receives from A (QUIC) and C (H2)
  agent2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: muti-metroo-agent2
    hostname: agent2
    volumes:
      - ./testbed/agent2/data:/app/data
      - ./testbed/agent2/config.yaml:/app/config.yaml:ro
      - ./testbed/certs:/app/certs:ro
    ports:
      - "8092:8080"   # Health/Metrics
    networks:
      - mesh

  # Agent C: Central hub, connects to B (H2) and D (WS), receives from E (QUIC)
  agent3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: muti-metroo-agent3
    hostname: agent3
    volumes:
      - ./testbed/agent3/data:/app/data
      - ./testbed/agent3/config.yaml:/app/config.yaml:ro
      - ./testbed/certs:/app/certs:ro
    ports:
      - "8093:8080"   # Health/Metrics
    networks:
      - mesh
    depends_on:
      - agent2
      - agent4

  # Agent D: Transit node, receives from C (WS) and F (WS)
  agent4:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: muti-metroo-agent4
    hostname: agent4
    volumes:
      - ./testbed/agent4/data:/app/data
      - ./testbed/agent4/config.yaml:/app/config.yaml:ro
      - ./testbed/certs:/app/certs:ro
    ports:
      - "8094:8080"   # Health/Metrics
    networks:
      - mesh

  # Agent E: Transit node, connects to C (QUIC) and F (H2)
  agent5:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: muti-metroo-agent5
    hostname: agent5
    volumes:
      - ./testbed/agent5/data:/app/data
      - ./testbed/agent5/config.yaml:/app/config.yaml:ro
      - ./testbed/certs:/app/certs:ro
    ports:
      - "8095:8080"   # Health/Metrics
      - "2777:2777"   # Forward listener
    networks:
      - mesh
    depends_on:
      - agent3
      - agent6

  # Agent F: Exit node, connects to D (WS), receives from E (H2)
  agent6:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: muti-metroo-agent6
    hostname: agent6
    volumes:
      - ./testbed/agent6/data:/app/data
      - ./testbed/agent6/config.yaml:/app/config.yaml:ro
      - ./testbed/certs:/app/certs:ro
    ports:
      - "8096:8080"   # Health/Metrics
    networks:
      - mesh
    depends_on:
      - agent4

  # Target server for testing
  target:
    image: nginx:alpine
    container_name: muti-metroo-target
    hostname: target
    networks:
      mesh:
        ipv4_address: 172.28.0.100

networks:
  mesh:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
